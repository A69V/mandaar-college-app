<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detailed Cricket Scoreboard</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#06b6d4; --glass: rgba(255,255,255,0.04);
      --team-a:#f97316; --team-b:#60a5fa;
      --radius:14px; --pad:16px; --shadow: 0 6px 24px rgba(2,6,23,0.6);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #071422 100%);color:#e6eef6}
    .wrap{max-width:1200px;margin:28px auto;padding:18px}
    .card{background:linear-gradient(180deg,var(--card), rgba(10,16,26,0.9));border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
    .board-grid{display:grid;grid-template-columns:1fr 400px;gap:18px}
    .main-column{display:flex;flex-direction:column;gap:18px}
    .controls-column{display:flex;flex-direction:column;gap:18px}
    .score-main{display:flex;align-items:center;justify-content:space-between;padding:20px;gap:16px}
    .score-main .team-name{font-size:32px;font-weight:700}
    .score-main .score{font-size:52px;font-weight:800;line-height:1}
    .score-main .overs{font-size:24px;color:var(--muted);font-weight:600}
    table.stats{width:100%;border-collapse:collapse;font-size:16px}
    table.stats th, table.stats td{padding:12px;text-align:left;border-bottom:1px solid var(--glass)}
    table.stats th{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    table.stats td{font-weight:600}
    table.stats .stat-num{text-align:right;font-family:monospace;font-size:18px;width:50px}
    table.stats .striker-dot{display:inline-block;width:8px;height:8px;background:var(--accent);border-radius:50%;margin-right:8px}
    .info-pills{display:flex;gap:10px;justify-content:center; flex-wrap: wrap;}
    .pill{background:var(--glass);padding:10px 16px;border-radius:999px;font-weight:600;font-size:15px}
    .pill .label{color:var(--muted);margin-right:6px}
    .controls-panel label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .controls-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px}
    .btn{
      background:var(--glass); border:1px solid rgba(255,255,255,0.06); color:inherit;
      padding:16px 12px; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600;
      transition:all 0.2s ease;
    }
    .btn:hover{background:rgba(255,255,255,0.1)}
    .btn.primary{background:linear-gradient(90deg,var(--accent), #7c3aed);border:none}
    .btn.wicket{background:linear-gradient(90deg,#f43f5e, #be123c);border:none}
    .btn.wide{background:linear-gradient(90deg,#eab308, #ca8a04);border:none}
    .row{display:flex;gap:8px}
    .flex{flex:1}
    select, input[type=text]{
        width:100%;padding:12px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);
        background:rgba(0,0,0,0.2);color:inherit;font-size:16px;
    }
    .modal-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center;
      z-index:1000;
      visibility:hidden; opacity:0;
      transition: all 0.2s ease-in-out;
    }
    .modal-box{
      background:var(--card);
      border-radius:var(--radius);
      padding:24px;
      box-shadow:var(--shadow);
      width:100%; max-width:400px;
    }
    .modal-overlay.visible{
      visibility:visible; opacity:1;
    }
    .modal-title{
      font-size:20px; font-weight:700;
      margin-top:0; margin-bottom:16px;
    }
    .over-summary-card { padding-bottom: 12px; }
    .over-summary-card label {
        font-size: 13px; color: var(--muted);
        display: block; margin-bottom: 10px;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    .over-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .ball-icon {
        width: 40px; height: 40px; border-radius: 50%;
        background: var(--glass);
        display: flex; align-items: center; justify-content: center;
        font-size: 15px; font-weight: 700;
        border: 1px solid rgba(255,255,255,0.06);
    }
    .ball-icon.wicket { background: #f43f5e; color: #fff; border: none; }
    .ball-icon.six { background: var(--accent); color: #000; border: none; }
    .ball-icon.four { background: #7c3aed; color: #fff; border: none; }
    .ball-icon.extra { font-size: 12px; background: #eab308; color: #000; border: none; }
    @media(max-width:980px){
        .board-grid{grid-template-columns:1fr}
        .ball-icon { width: 36px; height: 36px; font-size: 14px; }
    }
  </style>
</head>
<body>
  
  <div class="wrap">
    <h2 style="margin-top:0">Cricket Scorer</h2>

    <div class="board-grid">
      <div class="main-column">
        <div class="card score-main">
          <div>
            <div class="team-name" id="batting-team-name">Team A</div>
            <div class="muted">Batting</div>
          </div>
          <div style="text-align:right">
            <div class="score" id="main-score">0-0</div>
            <div class="overs" id="main-overs">(0.0)</div>
          </div>
        </div>
        
        <div class="card">
          <table class="stats">
            <thead>
              <tr>
                <th>Batsman</th>
                <th class="stat-num">R</th>
                <th class="stat-num">B</th>
                <th class="stat-num">4s</th>
                <th class="stat-num">6s</th>
                <th class="stat-num">SR</th>
              </tr>
            </thead>
            <tbody>
              <tr id="striker-row">
                <td><span class="striker-dot"></span><span id="striker-name">Batsman 1</span></td>
                <td class="stat-num" id="striker-runs">0</td>
                <td class="stat-num" id="striker-balls">0</td>
                <td class="stat-num" id="striker-fours">0</td>
                <td class="stat-num" id="striker-sixes">0</td>
                <td class="stat-num" id="striker-sr">0.00</td>
              </tr>
              <tr id="nonstriker-row">
                <td><span style="opacity:0" class="striker-dot"></span><span id="nonstriker-name">Batsman 2</span></td>
                <td class="stat-num" id="nonstriker-runs">0</td>
                <td class="stat-num" id="nonstriker-balls">0</td>
                <td class="stat-num" id="nonstriker-fours">0</td>
                <td class="stat-num" id="nonstriker-sixes">0</td>
                <td class="stat-num" id="nonstriker-sr">0.00</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <table class="stats">
            <thead>
              <tr>
                <th>Bowler</th>
                <th class="stat-num">O</th>
                <th class="stat-num">M</th>
                <th class="stat-num">R</th>
                <th class="stat-num">W</th>
                <th class="stat-num">Econ</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="bowler-name">Bowler 1</td>
                <td class="stat-num" id="bowler-overs">0.0</td>
                <td class="stat-num" id="bowler-maidens">0</td>
                <td class="stat-num" id="bowler-runs">0</td>
                <td class="stat-num" id="bowler-wickets">0</td>
                <td class="stat-num" id="bowler-econ">0.00</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card info-pills">
          <div class="pill"><span class="label">CRR:</span> <span id="crr">0.00</span></div>
          <div class="pill"><span class="label">Partnership:</span> <span id="partnership">0 (0)</span></div>
          <div class="pill"><span class="label">Extras:</span> <span id="extras">0</span></div>
        </div>

        <div class="card over-summary-card">
            <label>This Over</label>
            <div class="over-summary" id="over-summary">
            </div>
        </div>
        
      </div>

      <div class="controls-column">
        <div class="card controls-panel">
          <label>Scoring Controls</label>
          <div class="controls-grid">
            <button class="btn" id="btn-run-0">0</button>
            <button class="btn" id="btn-run-1">1</button>
            <button class="btn" id="btn-run-2">2</button>
            <button class="btn" id="btn-run-3">3</button>
            <button class="btn" id="btn-run-4">4</button>
            <button class="btn" id="btn-run-6">6</button>
            <button class="btn wide" id="btn-wide">Wide</button>
            <button class="btn" id="btn-noball">No Ball</button>
            <button class="btn" id="btn-legbye">Leg Bye</button>
            <button class="btn"id="btn-bye">Bye</button>
            <button class="btn wicket" id="btn-out">OUT</button>
            <button class="btn" id="btn-undo">Undo</button>
          </div>
        </div>

        <div class="card">
          <label>Match Controls</label>
          <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
            <button class="btn" id="btn-swap-strike">Swap Strike</button>
            <button class="btn" id="btn-next-over">End Over</button>
            <button class="btn primary" id="btn-next-inning">End Innings</button>
          </div>
        </div>
      </div>

    </div>
  </div>
  
  <div class="modal-overlay" id="modal-new-batsman">
    <div class="modal-box">
      <h3 class="modal-title">Wicket! Select New Batsman</h3>
      
      <label>Who is out?</label>
      <select id="select-batsman-out">
        </select>
      <br><br>
      
      <label>Dismissal Type</label>
      <select id="select-dismissal-type">
        <option value="bowled">Bowled</option>
        <option value="caught">Caught</option>
        <option value="lbw">LBW</option>
        <option value="run_out">Run Out</option>
        <option value="stumped">Stumped</option>
      </select>
      <br><br>
      
      <div id="fielder-row" style="display:none;">
          <label>Fielder (e.g., "Smith")</label>
          <input type="text" id="input-fielder" placeholder="Fielder's name"/>
          <br><br>
      </div>

      <label>Who is the new batsman?</label>
      <select id="select-batsman-in">
        </select>
      <br><br>
      
      <button class="btn primary" id="btn-confirm-batsman" style="width:100%">Confirm</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-new-bowler">
    <div class="modal-box">
      <h3 class="modal-title">End of Over! Select New Bowler</h3>
      <label>Select Bowler</label>
      <select id="select-bowler-new">
      </select>
      <br><br>
      <button class="btn primary" id="btn-confirm-bowler" style="width:100%">Confirm</button>
    </div>
  </div>


  <script>

    const state = {
      matchId: 'M1761289324603_qCfcnsljkq',
      teamA: {
        name: 'Team A (GECB)',
        players: [
          { id: 'p1', name: 'R. Sharma', role: 'Batsman', hasBatted: true },
          { id: 'p2', name: 'V. Kohli', role: 'Batsman', hasBatted: true },
          { id: 'p3', name: 'S. Gill', role: 'Batsman', hasBatted: false },
          { id: 'p4', name: 'S. Iyer', role: 'Batsman', hasBatted: false },
          { id: 'p5', name: 'KL Rahul', role: 'WK-Batsman', hasBatted: false },
          { id: 'p6', name: 'R. Jadeja', role: 'All-Rounder', hasBatted: false },
          { id: 'p7', name: 'H. Pandya', role: 'All-Rounder', hasBatted: false },
          { id: 'p8', name: 'J. Bumrah', role: 'Bowler', hasBatted: false },
          { id: 'p9', name: 'M. Shami', role: 'Bowler', hasBatted: false },
          { id: 'p10', name: 'M. Siraj', role: 'Bowler', hasBatted: false },
          { id: 'p11', name: 'K. Yadav', role: 'Bowler', hasBatted: false },
        ]
      },
      teamB: {
        name: 'Team B (Other)',
        players: [
          { id: 'p12', name: 'T. Head', role: 'Batsman', hasBatted: false },
          { id: 'p13', name: 'D. Warner', role: 'Batsman', hasBatted: false },
          { id: 'p14', name: 'M. Marsh', role: 'All-Rounder', hasBatted: false },
          { id: 'p15', name: 'S. Smith', role: 'Batsman', hasBatted: false },
          { id: 'p16', name: 'G. Maxwell', role: 'All-Rounder', hasBatted: false },
          { id: 'p17', name: 'P. Cummins', role: 'Bowler', hasBatted: false },
          { id: 'p18', name: 'M. Starc', role: 'Bowler', hasBatted: false },
        ]
      },
      totalOvers: 20,
      
      live: {
        inning: 1,
        battingTeam: 'teamA',
        bowlingTeam: 'teamB',
        score: 0,
        wickets: 0,
        balls: 0,
        overs: 0,
        batsmen: {
          striker: { id: 'p1', name: 'R. Sharma', runs: 0, balls: 0, fours: 0, sixes: 0 },
          nonStriker: { id: 'p2', name: 'V. Kohli', runs: 0, balls: 0, fours: 0, sixes: 0 }
        },
        bowler: { id: 'p17', name: 'P. Cummins', overs: 0, balls: 0, maidens: 0, runs: 0, wickets: 0 },
        extras: { total: 0, wides: 0, noBalls: 0, byes: 0, legByes: 0 },
        partnership: { runs: 0, balls: 0 },
        runRate: 0.0,
        ballHistory: [],
        thisOverSummary: [],
        fullBallLog: [] 
      },
      
      scorecard: {
        teamA: { batting: [], bowling: [] },
        teamB: { batting: [], bowling: [] }
      }
    };

    // --- 2. ELEMENT SELECTORS (MODIFIED) ---
    const el = {
      battingTeamName: document.getElementById('batting-team-name'),
      mainScore: document.getElementById('main-score'),
      mainOvers: document.getElementById('main-overs'),
      strikerName: document.getElementById('striker-name'),
      strikerRuns: document.getElementById('striker-runs'),
      strikerBalls: document.getElementById('striker-balls'),
      strikerFours: document.getElementById('striker-fours'),
      strikerSixes: document.getElementById('striker-sixes'),
      strikerSR: document.getElementById('striker-sr'),
      nonStrikerName: document.getElementById('nonstriker-name'),
      nonStrikerRuns: document.getElementById('nonstriker-runs'),
      nonStrikerBalls: document.getElementById('nonstriker-balls'),
      nonStrikerFours: document.getElementById('nonstriker-fours'),
      nonStrikerSixes: document.getElementById('nonstriker-sixes'),
      nonStrikerSR: document.getElementById('nonstriker-sr'),
      bowlerName: document.getElementById('bowler-name'),
      bowlerOvers: document.getElementById('bowler-overs'),
      bowlerMaidens: document.getElementById('bowler-maidens'),
      bowlerRuns: document.getElementById('bowler-runs'),
      bowlerWickets: document.getElementById('bowler-wickets'),
      bowlerEcon: document.getElementById('bowler-econ'),
      crr: document.getElementById('crr'),
      partnership: document.getElementById('partnership'),
      extras: document.getElementById('extras'),
      modalNewBatsman: document.getElementById('modal-new-batsman'),
      modalNewBowler: document.getElementById('modal-new-bowler'),
      selectBatsmanOut: document.getElementById('select-batsman-out'),
      selectBatsmanIn: document.getElementById('select-batsman-in'),
      selectBowlerNew: document.getElementById('select-bowler-new'),
      btnConfirmBatsman: document.getElementById('btn-confirm-batsman'),
      btnConfirmBowler: document.getElementById('btn-confirm-bowler'),
      
      // New Wicket Modal fields
      selectDismissalType: document.getElementById('select-dismissal-type'),
      inputFielder: document.getElementById('input-fielder'),
      fielderRow: document.getElementById('fielder-row'),
      
      overSummary: document.getElementById('over-summary')
    };

    // --- 3. THE RENDER FUNCTION ---
    function render() {
      const live = state.live;
      const striker = live.batsmen.striker || { name: '-', runs: 0, balls: 0, fours: 0, sixes: 0 };
      const nonStriker = live.batsmen.nonStriker || { name: '-', runs: 0, balls: 0, fours: 0, sixes: 0 };
      const bowler = live.bowler || { name: '-', overs: 0, balls: 0, maidens: 0, runs: 0, wickets: 0 };

      const totalBalls = live.overs * 6 + live.balls;
      const strikerSR = (striker.balls > 0) ? (striker.runs / striker.balls * 100).toFixed(2) : '0.00';
      const nonStrikerSR = (nonStriker.balls > 0) ? (nonStriker.runs / nonStriker.balls * 100).toFixed(2) : '0.00';
      const bowlerTotalBalls = bowler.overs * 6 + bowler.balls;
      const bowlerEcon = (bowlerTotalBalls > 0) ? (bowler.runs / bowlerTotalBalls * 6).toFixed(2) : '0.00';
      const bowlerOversStr = `${bowler.overs}.${bowler.balls}`;
      live.runRate = (totalBalls > 0) ? (live.score / totalBalls * 6).toFixed(2) : '0.00';
      
      el.battingTeamName.textContent = state[live.battingTeam].name;
      el.mainScore.textContent = `${live.score}-${live.wickets}`;
      el.mainOvers.textContent = `(${live.overs}.${live.balls})`;
      el.strikerName.textContent = striker.name;
      el.strikerRuns.textContent = striker.runs;
      el.strikerBalls.textContent = striker.balls;
      el.strikerFours.textContent = striker.fours;
      el.strikerSixes.textContent = striker.sixes;
      el.strikerSR.textContent = strikerSR;
      el.nonStrikerName.textContent = nonStriker.name;
      el.nonStrikerRuns.textContent = nonStriker.runs;
      el.nonStrikerBalls.textContent = nonStriker.balls;
      el.nonStrikerFours.textContent = nonStriker.fours;
      el.nonStrikerSixes.textContent = nonStriker.sixes;
      el.nonStrikerSR.textContent = nonStrikerSR;
      el.bowlerName.textContent = bowler.name;
      el.bowlerOvers.textContent = bowlerOversStr;
      el.bowlerMaidens.textContent = bowler.maidens;
      el.bowlerRuns.textContent = bowler.runs;
      el.bowlerWickets.textContent = bowler.wickets;
      el.bowlerEcon.textContent = bowlerEcon;
      el.crr.textContent = live.runRate;
      el.partnership.textContent = `${live.partnership.runs} (${live.partnership.balls})`;
      el.extras.textContent = live.extras.total;

      el.overSummary.innerHTML = ''; // Clear it
      live.thisOverSummary.forEach(ballEvent => {
        const ballEl = document.createElement('div');
        ballEl.classList.add('ball-icon');
        let text = ballEvent;
        
        if (ballEvent === 'W') { ballEl.classList.add('wicket'); }
        else if (ballEvent === '6') { ballEl.classList.add('six'); }
        else if (ballEvent === '4') { ballEl.classList.add('four'); }
        else if (ballEvent === '.') { text = 'â€¢'; }
        else if (ballEvent.includes('wd') || ballEvent.includes('nb') || ballEvent.includes('b') || ballEvent.includes('lb')) {
            ballEl.classList.add('extra');
        }
        
        ballEl.textContent = text;
        el.overSummary.appendChild(ballEl);
      });
    }

    // --- 4. LOGIC HELPER FUNCTIONS (MODIFIED) ---
    function swapStrike() {
      console.log('Swapping strike');
      const temp = state.live.batsmen.striker;
      state.live.batsmen.striker = state.live.batsmen.nonStriker;
      state.live.batsmen.nonStriker = temp;
    }
    
    // (Fixed endOfOver)
    function endOfOver() {
      console.log('--- END OF OVER ---');
      state.live.balls = 0;
      state.live.overs++;
      state.live.bowler.overs++;
      state.live.bowler.balls = 0;
      state.live.thisOverSummary = []; // Clear summary immediately
      swapStrike();
      populateBowlerDropdown();
      showModal(el.modalNewBowler);
    }
    
    // (Modified handleWicket)
    function handleWicket() {
      console.log('--- WICKET ---');
      state.live.wickets++;
      state.live.bowler.wickets++;
      state.live.partnership = { runs: 0, balls: 0 };
      
      // Reset wicket modal fields
      el.selectDismissalType.value = 'bowled';
      el.inputFielder.value = '';
      el.fielderRow.style.display = 'none';

      if (state.live.wickets === 10) {
        alert("Innings Over!");
      } else {
        populateBatsmanDropdowns();
        showModal(el.modalNewBatsman);
      }
    }
    
    // (Optimized undoLastBall)
    function undoLastBall() {
        const lastStateSnapshot = state.live.ballHistory.pop(); 
        if (!lastStateSnapshot) {
            console.log('No history to undo.');
            return;
        }
        const lastLiveState = JSON.parse(lastStateSnapshot); 
        const currentHistoryArray = state.live.ballHistory;
        state.live = lastLiveState; 
        state.live.ballHistory = currentHistoryArray;
        console.log('Undo successful.');
        render();
    }
    
    // --- 5. MODAL FUNCTIONS (MODIFIED) ---
    function showModal(modalElement) {
      modalElement.classList.add('visible');
    }
    
    function hideModal(modalElement) {
      modalElement.classList.remove('visible');
    }

    function populateBatsmanDropdowns() {
      const { striker, nonStriker } = state.live.batsmen;
      el.selectBatsmanOut.innerHTML = `
        <option value="${striker.id}">${striker.name} (Striker)</option>
        <option value="${nonStriker.id}">${nonStriker.name} (Non-Striker)</option>
      `;
      const battingTeam = state.live.battingTeam;
      const playersNotBatted = state[battingTeam].players.filter(p => !p.hasBatted);
      el.selectBatsmanIn.innerHTML = playersNotBatted
        .map(p => `<option value="${p.id}">${p.name} (${p.role})</option>`)
        .join('');
    }
    
    function populateBowlerDropdown() {
      const bowlingTeam = state.live.bowlingTeam;
      const availableBowlers = state[bowlingTeam].players.filter(
        p => (p.role.includes('Bowler') || p.role.includes('All-Rounder')) && p.id !== state.live.bowler.id
      );
      el.selectBowlerNew.innerHTML = availableBowlers
        .map(p => `<option value="${p.id}">${p.name} (${p.role})</option>`)
        .join('');
    }
    
    // (MODIFIED confirmNewBatsman)
    function confirmNewBatsman() {
      const batsmanOutId = el.selectBatsmanOut.value;
      const batsmanInId = el.selectBatsmanIn.value;
      const dismissalType = el.selectDismissalType.value;
      const fielderName = el.inputFielder.value;
      
      const battingTeam = state.live.battingTeam;
      const newPlayer = state[battingTeam].players.find(p => p.id === batsmanInId);
      
      if (!newPlayer) return;
      newPlayer.hasBatted = true;
      
      const batsmanOutObject = (state.live.batsmen.striker.id === batsmanOutId) 
                                ? state.live.batsmen.striker 
                                : state.live.batsmen.nonStriker;

      let dismissalString = "";
      const bowlerLastName = state.live.bowler.name.split(' ').pop();

      switch (dismissalType) {
          case 'bowled':
              dismissalString = `b. ${bowlerLastName}`;
              break;
          case 'caught':
              dismissalString = `c. ${fielderName || 'Fielder'} b. ${bowlerLastName}`;
              break;
          case 'lbw':
              dismissalString = `lbw b. ${bowlerLastName}`;
              break;
          case 'run_out':
              dismissalString = `run out (${fielderName || 'Fielder'})`;
              break;
          case 'stumped':
              dismissalString = `st. ${fielderName || 'Fielder'} b. ${bowlerLastName}`;
              break;
      }
      
      const batsmanOutData = {
        ...batsmanOutObject,
        dismissal: dismissalString,
        bowlerId: state.live.bowler.id
      };
      state.scorecard[battingTeam].batting.push(batsmanOutData);
      
      const newBatsman = {
        id: newPlayer.id,
        name: newPlayer.name,
        runs: 0, balls: 0, fours: 0, sixes: 0
      };
      
      if (state.live.batsmen.striker.id === batsmanOutId) {
        state.live.batsmen.striker = newBatsman;
      } else {
        state.live.batsmen.nonStriker = newBatsman;
      }
      
      hideModal(el.modalNewBatsman);
      render();

      // *** FIX: Save to Firebase IMMEDIATELY ***
      try { window.saveToFirebase(); } catch (e) { console.warn(e); }

      // (Fixed logic for over-end-on-wicket)
      if (state.live.balls === 6 && state.live.wickets < 10) {
          endOfOver();
      }
    }
    
    // (MODIFIED confirmNewBowler)
    function confirmNewBowler() {
      const bowlerInId = el.selectBowlerNew.value;
      const bowlingTeam = state.live.bowlingTeam;
      const newPlayer = state[bowlingTeam].players.find(p => p.id === bowlerInId);
      
      if (!newPlayer) return;
      
      const oldBowlerStats = state.live.bowler;
      const existingBowler = state.scorecard[bowlingTeam].bowling.find(b => b.id === oldBowlerStats.id);

      if (existingBowler) {
        Object.assign(existingBowler, oldBowlerStats);
      } else if (oldBowlerStats.overs > 0 || oldBowlerStats.balls > 0) {
        state.scorecard[bowlingTeam].bowling.push(oldBowlerStats);
      }

      state.live.bowler = {
        id: newPlayer.id,
        name: newPlayer.name,
        overs: 0, balls: 0, maidens: 0, runs: 0, wickets: 0
      };
      
      hideModal(el.modalNewBowler);
      render();

      // *** FIX: Save to Firebase IMMEDIATELY ***
      try { window.saveToFirebase(); } catch (e) { console.warn(e); }
    }


    // --- 6. THE SCORING ENGINE (THE "BRAIN") ---
    function recordBall(ballData) {
        // 1. Save history (with memory leak fix)
        const liveStateSnapshot = JSON.parse(JSON.stringify(state.live));
        delete liveStateSnapshot.ballHistory; 
        state.live.ballHistory.push(JSON.stringify(liveStateSnapshot));
        if (state.live.ballHistory.length > 50) {
            state.live.ballHistory.shift();
        }
        
        const live = state.live;
        const striker = live.batsmen.striker;
        const bowler = live.bowler;
        const runs = ballData.runs;
        let isWicket = ballData.isWicket;
        let ballEventString = '';
        
        const ballLogEntry = {
          over: live.overs,
          ball: live.balls + 1,
          batsmanId: striker.id,
          batsmanName: striker.name,
          bowlerId: bowler.id,
          bowlerName: bowler.name,
          extra: ballData.isExtra,
          isWicket: ballData.isWicket
        };

        // 2. Handle non-legal deliveries
        if (ballData.isExtra === 'wd') {
          live.score += runs;
          live.extras.wides += runs;
          live.extras.total += runs;
          bowler.runs += runs;
          ballEventString = (runs > 1) ? `${runs}wd` : 'wd';
        } else if (ballData.isExtra === 'nb') {
          live.score += runs;
          live.extras.noBalls++; 
          live.extras.total += runs;
          bowler.runs += runs;
          const runsOffBat = runs - 1;
          if (runsOffBat > 0) {
            striker.runs += runsOffBat;
            live.partnership.runs += runsOffBat;
            if (runsOffBat === 4) striker.fours++;
            if (runsOffBat === 6) striker.sixes++;
            if (runsOffBat % 2 !== 0) swapStrike();
          }
          ballEventString = (runsOffBat > 0) ? `${runsOffBat}nb` : 'nb';
        } else {
          // 3. Handle legal deliveries
          live.balls++;
          bowler.balls++;
          live.partnership.balls++;
          
          if (ballData.isExtra === 'b' || ballData.isExtra === 'lb') {
            live.score += runs;
            live.extras.total += runs;
            striker.balls++;
            if (ballData.isExtra === 'b') live.extras.byes += runs;
            if (ballData.isExtra === 'lb') live.extras.legByes += runs;
            ballEventString = `${runs}${ballData.isExtra}`;
          } else {
            // Standard run off the bat
            live.score += runs;
            striker.runs += runs;
            striker.balls++;
            bowler.runs += runs;
            live.partnership.runs += runs;
            if (runs === 4) striker.fours++;
            if (runs === 6) striker.sixes++;
            if (runs === 0) { ballEventString = '.'; }
            else { ballEventString = String(runs); }
          }
          
          // 4. Handle strike rotation
          const runsThatSwap = [1, 3, 5];
          if (runsThatSwap.includes(runs)) {
            swapStrike();
          }
        }
        
        // 5. Handle Wicket AFTER processing runs
        if (isWicket) {
          handleWicket();
          ballEventString = 'W'; 
        }
        
        // 6. Push event to summary
        live.thisOverSummary.push(ballEventString);
        
        // 7. Add final details to log and push it
        ballLogEntry.runs = runs;
        ballLogEntry.totalScore = live.score;
        ballLogEntry.totalWickets = live.wickets;
        live.fullBallLog.push(ballLogEntry);
        
        // 8. Handle End of Over
        if (live.balls === 6 && !isWicket && ballData.isExtra !== 'wd' && ballData.isExtra !== 'nb') {
          endOfOver();
        }
        
        // 9. Update and Render
        render();

        // 10. Save to Firebase
        try {
            window.saveToFirebase();
        } catch (e) {
            console.warn("Firebase not ready or saveToFirebase not defined yet.");
        }
    }
    
    // --- 7. EVENT LISTENERS ---
    
    // Run buttons
    document.getElementById('btn-run-0').addEventListener('click', () => recordBall({ runs: 0, isExtra: null, isWicket: false }));
    document.getElementById('btn-run-1').addEventListener('click', () => recordBall({ runs: 1, isExtra: null, isWicket: false }));
    document.getElementById('btn-run-2').addEventListener('click', () => recordBall({ runs: 2, isExtra: null, isWicket: false }));
    document.getElementById('btn-run-3').addEventListener('click', () => recordBall({ runs: 3, isExtra: null, isWicket: false }));
    document.getElementById('btn-run-4').addEventListener('click', () => recordBall({ runs: 4, isExtra: null, isWicket: false }));
    // *** FIXED 6-RUN BUTTON ***
    document.getElementById('btn-run-6').addEventListener('click', () => recordBall({ runs: 6, isExtra: null, isWicket: false }));

    // Extra buttons
    document.getElementById('btn-wide').addEventListener('click', () => {
      const runs = parseInt(prompt('Total runs from Wide? (e.g., 1 for 1 wide, 5 for 1 wide + 4 overthrows)', '1')) || 0;
      if (runs > 0) recordBall({ runs: runs, isExtra: 'wd', isWicket: false });
    });
    document.getElementById('btn-noball').addEventListener('click', () => {
      const runs = parseInt(prompt('Total runs from No Ball? (1 for NB + runs off bat. e.g., 1, 5)', '1')) || 0;
      if (runs > 0) recordBall({ runs: runs, isExtra: 'nb', isWicket: false });
    });
    document.getElementById('btn-legbye').addEventListener('click', () => {
      const runs = parseInt(prompt('How many Leg Byes?', '1')) || 0;
      if (runs > 0) recordBall({ runs: runs, isExtra: 'lb', isWicket: false });
    });
    document.getElementById('btn-bye').addEventListener('click', () => {
      const runs = parseInt(prompt('How many Byes?', '1')) || 0;
      if (runs > 0) recordBall({ runs: runs, isExtra: 'b', isWicket: false });
    });

    // Wicket button
    document.getElementById('btn-out').addEventListener('click', () => {
      recordBall({ runs: 0, isExtra: null, isWicket: true });
    });

    // Other controls
    document.getElementById('btn-swap-strike').addEventListener('click', () => {
      swapStrike();
      render();
    });
    document.getElementById('btn-next-over').addEventListener('click', () => {
      endOfOver();
    });
    document.getElementById('btn-undo').addEventListener('click', undoLastBall);
    
    // Modal controls
    el.btnConfirmBatsman.addEventListener('click', confirmNewBatsman);
    el.btnConfirmBowler.addEventListener('click', confirmNewBowler);

    // --- 8. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      const initialBowler = state.teamB.players.find(p => p.id === state.live.bowler.id);
      if (initialBowler) {
        state.live.bowler.name = initialBowler.name;
      }
      render();
      
      // *** NEW: Listener for fielder input show/hide ***
      el.selectDismissalType.addEventListener('change', (e) => {
        const type = e.target.value;
        if (type === 'caught' || type === 'run_out' || type === 'stumped') {
          el.fielderRow.style.display = 'block';
        } else {
          el.fielderRow.style.display = 'none';
        }
      });
    });
  </script>
  
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // 
    // === PASTE YOUR REAL FIREBASE CONFIG OBJECT HERE ===
    // 
    const firebaseConfig = {
      apiKey: "AIzaSyAOtc2UrW2hXO4JJK5ZZQcDOfUVbEFmnis",
      authDomain: "umang-mandar.firebaseapp.com",
      projectId: "umang-mandar",
      storageBucket: "umang-mandar.firebasestorage.app",
      messagingSenderId: "1033556658773",
      appId: "1:1033556658773:web:ed5c606f77e792136ae2dc",
      measurementId: "G-DWS6SVRR3R",
      databaseURL: "https://umang-mandar-default-rtdb.asia-southeast1.firebasedatabase.app/" 
}; 
    // === END OF YOUR CONFIG ===


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Make the save function globally available
    window.saveToFirebase = () => {
      if (!state.matchId) {
        console.error("Match ID is not set. Cannot save.");
        return;
      }
      set(ref(db, 'matches/' + state.matchId), state)
        .then(() => {
          console.log('Data saved to Firebase');
        })
        .catch((error) => {
          console.error('Error saving data:', error);
        });
    }
  </script>
</body>
</html>