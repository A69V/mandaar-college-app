<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Match Setup — Cricket</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,system-ui;padding:20px;background:#071022;color:#e6eef6}
    .card{background:#0b1220;padding:18px;border-radius:12px;max-width:900px;margin:16px auto}
    label{display:block;color:#9aa6b2;margin-top:10px}
    select,input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{margin-top:12px;padding:10px 12px;border-radius:8px;background:#06b6d4;border:none;color:#012;cursor:pointer;font-weight:700}
    .row{display:flex;gap:12px}
    .col{flex:1}
  </style>
</head>
<body>
  <div class="card">
    <h2>Create Match</h2>
    <div>
      <label>Match Code (unique)</label>
      <input id="matchCode" placeholder="GECB_MANDAAR_2025_FINAL" />
      <label>Title</label>
      <input id="title" placeholder="GECB vs Opp — Final" />
      <label>Venue</label>
      <input id="venue" placeholder="GEC Banka Ground" />
      <label>Overs (limit)</label>
      <input id="oversLimit" type="number" value="20" />
      <div class="row">
        <div class="col">
          <label>Team A</label>
          <select id="teamA"></select>
        </div>
        <div class="col">
          <label>Team B</label>
          <select id="teamB"></select>
        </div>
      </div>
      <label>Toss Winner</label>
      <select id="tossWinner">
        <option value="">--select--</option>
      </select>
      <label>Toss Decision</label>
      <select id="tossDecision">
        <option value="bat">Bat</option>
        <option value="bowl">Bowl</option>
      </select>

      <button id="createMatch">Create Match & Start</button>
      <p id="status" style="color:#9aa6b2"></p>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ----- CONFIG: paste your Firebase web config here -----
    const FIREBASE_CONFIG = null; // <-- replace with your firebaseConfig object
    // ------------------------------------------------------

    if(!FIREBASE_CONFIG){ console.warn('FIREBASE_CONFIG not set. Paste your config into FIREBASE_CONFIG variable.'); }

    if(FIREBASE_CONFIG){
      firebase.initializeApp(FIREBASE_CONFIG);
      window.db = firebase.database();
    }

    // load local players JSON
    let playersDB = null;
    async function loadPlayers(){
      const res = await fetch('players.json');
      playersDB = await res.json();
      const teamA = document.getElementById('teamA'), teamB = document.getElementById('teamB'), tossWinner = document.getElementById('tossWinner');
      teamA.innerHTML = ''; teamB.innerHTML = ''; tossWinner.innerHTML = '<option value=\"\">--select--</option>';
      playersDB.teams.forEach(t=>{
        const o1 = document.createElement('option'); o1.value = t.id; o1.textContent = t.name; teamA.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = t.id; o2.textContent = t.name; teamB.appendChild(o2);
        const o3 = document.createElement('option'); o3.value = t.id; o3.textContent = t.name; tossWinner.appendChild(o3);
      });
    }

    loadPlayers();

    document.getElementById('createMatch').addEventListener('click', async ()=>{
      const code = document.getElementById('matchCode').value.trim() || ('match_'+Date.now());
      const title = document.getElementById('title').value || code;
      const venue = document.getElementById('venue').value || '';
      const oversLimit = Number(document.getElementById('oversLimit').value) || 20;
      const teamA = document.getElementById('teamA').value;
      const teamB = document.getElementById('teamB').value;
      const tossWinner = document.getElementById('tossWinner').value;
      const tossDecision = document.getElementById('tossDecision').value;

      if(!teamA || !teamB || teamA===teamB){ alert('Choose two different teams'); return; }
      const matchId = code;

      const matchObj = {
        matchId,
        title,
        venue,
        oversLimit,
        status: 'live',
        teamA,
        teamB,
        toss:{ winner: tossWinner || null, decision: tossDecision || null },
        createdAt: Date.now()
      };

      // initial innings 1 (if toss says bat, batting team = tossWinner; else other)
      let battingTeam = teamA;
      if(tossWinner){
        if(tossDecision === 'bat') battingTeam = tossWinner;
        else battingTeam = (tossWinner === teamA) ? teamB : teamA;
      }

      // create basic live snapshot
      const liveSnapshot = {
        matchId,
        currentInnings: 1,
        battingTeam,
        bowlingTeam: (battingTeam === teamA) ? teamB : teamA,
        score: 0,
        wickets: 0,
        balls: 0,
        overs: 0,
        extras: { total:0, wides:0, noBalls:0, byes:0, legByes:0 },
        batsmen: { striker: null, nonStriker: null },
        bowler: null,
        partnership: { runs:0, balls:0 },
        runRate: 0.0,
        lastBall: null,
        updatedAt: Date.now()
      };

      // write to Realtime DB
      if(!window.db){ // if firebase not configured we still open the live page with local state
        document.getElementById('status').textContent = 'Firebase not configured — running local demo. Redirecting...';
        // store in session so live.html can pick it up
        sessionStorage.setItem('demo_match', JSON.stringify({ matchObj, liveSnapshot, playersDB }));
        setTimeout(()=> location.href = `live.html?matchId=${matchId}`, 700);
        return;
      }

      try{
        await db.ref('sports/cricket/matches/'+matchId).set(matchObj);
        await db.ref('sports/cricket/live/'+matchId).set(liveSnapshot);
        // also push initial innings metadata
        await db.ref('sports/cricket/matches/'+matchId+'/innings/1').set({
          inningNo:1, battingTeamId: battingTeam, bowlingTeamId: (battingTeam === teamA) ? teamB : teamA, runs:0, wickets:0, balls:0, overs:0, extras:{}, isCompleted:false
        });
        document.getElementById('status').textContent = 'Match created — opening live scorer...';
        // redirect to live page
        setTimeout(()=> location.href = `live.html?matchId=${matchId}`, 800);
      }catch(err){
        console.error(err);
        alert('Firebase write failed. Check console.');
      }
    });
  </script>
</body>
</html>
