<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Setup New Cricket Match</title>
    <style>
        /* Using similar styles for consistency */
        :root{
          --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#06b6d4; --glass: rgba(255,255,255,0.04);
          --radius:14px; --pad:16px; --shadow: 0 6px 24px rgba(2,6,23,0.6);
          font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #071422 100%);color:#e6eef6}
        .wrap{max-width:700px;margin:40px auto;padding:20px}
        .card{background:linear-gradient(180deg,var(--card), rgba(10,16,26,0.9));border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow); margin-bottom: 20px;}
        label { font-size: 14px; color: var(--muted); display: block; margin-bottom: 6px; }
        input[type=text], input[type=number], select {
            width:100%; padding:12px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
            background:rgba(0,0,0,0.2); color:inherit; font-size:16px; margin-bottom: 15px;
        }
        .btn{
          background:var(--glass); border:1px solid rgba(255,255,255,0.06); color:inherit;
          padding:14px 20px; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600;
          transition:all 0.2s ease; width: 100%; margin-top: 10px;
        }
        .btn:hover{background:rgba(255,255,255,0.1)}
        .btn.primary{background:linear-gradient(90deg,var(--accent), #7c3aed);border:none}
        .hidden { display: none; }
        h2 { margin-top: 0; }
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
    </style>
</head>
<body>
    <div class="wrap">
        <h2>Setup New Cricket Match</h2>

        <div id="step-1" class="card">
            <h3>Match Details</h3>
            <label for="match-id">Unique Match ID (e.g., TEAMAvsTEAMB_DATE)</label>
            <input type="text" id="match-id" value="cse-vs-civil-match-1">

            <label for="venue">Venue</label>
            <input type="text" id="venue" value="GEC Banka Playground">

            <label for="total-overs">Overs per Innings</label>
            <input type="number" id="total-overs" value="20" min="1">
            <button class="btn primary" onclick="nextStep(2)">Next: Teams</button>
        </div>

        <div id="step-2" class="card hidden">
            <h3>Team Setup</h3>
            <div class="row">
                <div class="col">
                    <label for="team-a-name">Team A Name</label>
                    <input type="text" id="team-a-name" value="Team A (GECB)">
                    <label for="team-a-players">Team A Players (One per line: ID, Name, Role)</label>
                    <textarea id="team-a-players" rows="12" style="width:100%; background:rgba(0,0,0,0.2); color:inherit; border:1px solid rgba(255,255,255,0.06); border-radius:8px; padding:10px; font-size: 14px;">p1, R. Sharma, Batsman
p2, V. Kohli, Batsman
p3, S. Gill, Batsman
p4, S. Iyer, Batsman
p5, KL Rahul, WK-Batsman
p6, R. Jadeja, All-Rounder
p7, H. Pandya, All-Rounder
p8, J. Bumrah, Bowler
p9, M. Shami, Bowler
p10, M. Siraj, Bowler
p11, K. Yadav, Bowler</textarea>
                </div>
                <div class="col">
                    <label for="team-b-name">Team B Name</label>
                    <input type="text" id="team-b-name" value="Team B (Visitors)">
                     <label for="team-b-players">Team B Players (One per line: ID, Name, Role)</label>
                    <textarea id="team-b-players" rows="12" style="width:100%; background:rgba(0,0,0,0.2); color:inherit; border:1px solid rgba(255,255,255,0.06); border-radius:8px; padding:10px; font-size: 14px;">p12, T. Head, Batsman
p13, D. Warner, Batsman
p14, M. Marsh, All-Rounder
p15, S. Smith, Batsman
p16, G. Maxwell, All-Rounder
p17, P. Cummins, Bowler
p18, M. Starc, Bowler
p19, J. Hazlewood, Bowler
p20, A. Zampa, Bowler
p21, A. Carey, WK-Batsman
p22, M. Labuschagne, Batsman</textarea>
                </div>
            </div>
             <button class="btn" onclick="prevStep(1)">Back</button>
            <button class="btn primary" onclick="processTeams()">Next: Toss</button>
        </div>

        <div id="step-3" class="card hidden">
            <h3>Toss & Opening Players</h3>
            <label for="toss-winner">Who won the toss?</label>
            <select id="toss-winner">
                </select>

            <label for="elected-to">Elected to?</label>
            <select id="elected-to">
                <option value="bat">Bat</option>
                <option value="bowl">Bowl</option>
            </select>

            <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

            <div id="opening-selection">
                <label>Opening Batsman (Striker)</label>
                <select id="select-striker">
                    </select>

                <label>Opening Batsman (Non-Striker)</label>
                <select id="select-nonstriker">
                    </select>

                <label>Opening Bowler</label>
                <select id="select-bowler">
                    </select>
            </div>
            <button class="btn" onclick="prevStep(2)">Back</button>
            <button class="btn primary" onclick="startMatch()">Start Match</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // === PASTE YOUR REAL FIREBASE CONFIG OBJECT HERE ===
        const firebaseConfig = {
      apiKey: "AIzaSyAOtc2UrW2hXO4JJK5ZZQcDOfUVbEFmnis",
      authDomain: "umang-mandar.firebaseapp.com",
      projectId: "umang-mandar",
      storageBucket: "umang-mandar.firebasestorage.app",
      messagingSenderId: "1033556658773",
      appId: "1:1033556658773:web:ed5c606f77e792136ae2dc",
      measurementId: "G-DWS6SVRR3R",
      databaseURL: "https://umang-mandar-default-rtdb.asia-southeast1.firebasedatabase.app/" 
}; 
        // === END OF YOUR CONFIG ===

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Make save function global
        window.saveInitialState = (matchId, state) => {
             if (!matchId || !state) {
                console.error("Match ID or state missing for initial save.");
                alert("Error: Match ID or state missing.");
                return Promise.reject("Missing data"); // Return a rejected promise
            }
           console.log("Saving initial state for match:", matchId);
           return set(ref(db, 'matches/' + matchId), state); // Return the promise
        }
    </script>

    <script>
        let tempState = { teamA: { players: [] }, teamB: { players: [] } }; // Temporary storage

        function nextStep(step) {
            document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
        }
        function prevStep(step) {
            document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
        }

        function parsePlayers(textAreaId) {
            const text = document.getElementById(textAreaId).value.trim();
            const players = [];
            const lines = text.split('\n');
            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length === 3 && parts[0] && parts[1] && parts[2]) {
                    players.push({ id: parts[0], name: parts[1], role: parts[2], hasBatted: false });
                }
            });
            return players;
        }

        function processTeams() {
            tempState.teamA.name = document.getElementById('team-a-name').value || 'Team A';
            tempState.teamB.name = document.getElementById('team-b-name').value || 'Team B';
            tempState.teamA.players = parsePlayers('team-a-players');
            tempState.teamB.players = parsePlayers('team-b-players');

            if (tempState.teamA.players.length < 2 || tempState.teamB.players.length < 1) {
                alert("Please ensure Team A has at least 2 players and Team B has at least 1 player defined correctly (ID, Name, Role per line).");
                return;
            }

            // Populate toss winner dropdown
            document.getElementById('toss-winner').innerHTML = `
                <option value="teamA">${tempState.teamA.name}</option>
                <option value="teamB">${tempState.teamB.name}</option>
            `;

            populateOpeningPlayerDropdowns(); // Populate dropdowns for next step
            nextStep(3);
        }

        function populateOpeningPlayerDropdowns() {
            const tossWinner = document.getElementById('toss-winner').value;
            const electedTo = document.getElementById('elected-to').value;

            let battingTeamKey, bowlingTeamKey;
            if ((tossWinner === 'teamA' && electedTo === 'bat') || (tossWinner === 'teamB' && electedTo === 'bowl')) {
                battingTeamKey = 'teamA';
                bowlingTeamKey = 'teamB';
            } else {
                battingTeamKey = 'teamB';
                bowlingTeamKey = 'teamA';
            }

            // Store for later use
            tempState.initialBattingTeam = battingTeamKey;
            tempState.initialBowlingTeam = bowlingTeamKey;

            const battingPlayers = tempState[battingTeamKey].players;
            const bowlingPlayers = tempState[bowlingTeamKey].players.filter(p => p.role.includes('Bowler') || p.role.includes('All-Rounder'));

            document.getElementById('select-striker').innerHTML = battingPlayers
                .map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('select-nonstriker').innerHTML = battingPlayers
                .map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('select-bowler').innerHTML = bowlingPlayers
                .map(p => `<option value="${p.id}">${p.name}</option>`).join('');

             // Set default selections (e.g., first two batsmen, first bowler)
             if (battingPlayers.length >= 2) {
                 document.getElementById('select-striker').selectedIndex = 0;
                 document.getElementById('select-nonstriker').selectedIndex = 1;
             }
             if (bowlingPlayers.length >= 1) {
                  document.getElementById('select-bowler').selectedIndex = 0;
             }
        }

        // Update opening player dropdowns if toss winner/decision changes
        document.getElementById('toss-winner').addEventListener('change', populateOpeningPlayerDropdowns);
        document.getElementById('elected-to').addEventListener('change', populateOpeningPlayerDropdowns);


        async function startMatch() {
            const matchId = document.getElementById('match-id').value.trim();
            if (!matchId) {
                alert("Please enter a unique Match ID.");
                return;
            }

            const strikerId = document.getElementById('select-striker').value;
            const nonStrikerId = document.getElementById('select-nonstriker').value;
            const bowlerId = document.getElementById('select-bowler').value;

            if (strikerId === nonStrikerId) {
                alert("Striker and Non-Striker cannot be the same player.");
                return;
            }
             if (!strikerId || !nonStrikerId || !bowlerId) {
                 alert("Please select opening striker, non-striker, and bowler.");
                 return;
             }


            const battingTeamKey = tempState.initialBattingTeam;
            const bowlingTeamKey = tempState.initialBowlingTeam;

            // Find player objects
            const striker = tempState[battingTeamKey].players.find(p => p.id === strikerId);
            const nonStriker = tempState[battingTeamKey].players.find(p => p.id === nonStrikerId);
            const bowler = tempState[bowlingTeamKey].players.find(p => p.id === bowlerId);

            if (!striker || !nonStriker || !bowler) {
                alert("Error finding selected players. Check player lists.");
                return;
            }

            // Mark opening batsmen as having batted
            striker.hasBatted = true;
            nonStriker.hasBatted = true;


            // Construct the initial state object
            const initialState = {
              matchId: matchId,
              venue: document.getElementById('venue').value,
              teamA: tempState.teamA,
              teamB: tempState.teamB,
              totalOvers: parseInt(document.getElementById('total-overs').value) || 20,
              toss: {
                  winner: tempState[document.getElementById('toss-winner').value].name,
                  elected: document.getElementById('elected-to').value
              },
              live: {
                inning: 1,
                battingTeam: battingTeamKey,
                bowlingTeam: bowlingTeamKey,
                score: 0, wickets: 0, balls: 0, overs: 0,
                batsmen: {
                  striker: { id: striker.id, name: striker.name, runs: 0, balls: 0, fours: 0, sixes: 0 },
                  nonStriker: { id: nonStriker.id, name: nonStriker.name, runs: 0, balls: 0, fours: 0, sixes: 0 }
                },
                bowler: { id: bowler.id, name: bowler.name, overs: 0, balls: 0, maidens: 0, runs: 0, wickets: 0 },
                extras: { total: 0, wides: 0, noBalls: 0, byes: 0, legByes: 0 },
                partnership: { runs: 0, balls: 0 },
                runRate: 0.0,
                ballHistory: [], // For undo in scorer
                thisOverSummary: [],
                fullBallLog: [],
                matchStatus: "1st Inning Live", // Initial status
                targetScore: null // No target yet
              },
              scorecard: {
                teamA: { batting: [], bowling: [] },
                teamB: { batting: [], bowling: [] }
              },
              innings: {}, // To store completed innings data later
              result: null // Final result later
            };

            // Save to Firebase using the globally defined function
            try {
                await window.saveInitialState(matchId, initialState);
                console.log("Initial state saved successfully.");
                // Redirect to scorer page, passing the matchId
                window.location.href = `cricket-scorer.html?matchId=${encodeURIComponent(matchId)}`;
            } catch (error) {
                console.error("Error saving initial state:", error);
                alert("Failed to save initial match state to database. Please check console.");
            }
        }
    </script>

</body>
</html>